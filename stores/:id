<div class="store_detail" id="store_detail">
    <script id="store_detail_template" type="x-tmpl-mustache/text">
        <div class="map_area">
        
        <div class="store_img">
            
            <img src="{{store_front_url_abs}}" alt="Store Imahge" />
            
            <div id="mapsvg"></div>             
            <span id="compass">&nbsp;</span> 
            <a id="mapshot-toggle" href="javascript:toggle_map();"></a>
        </div>
        
        <div class="store_list_padding">
            <h2 class="store_profile" id="store_profile">Store profile</h2>   
            <h2 class="store_profile" id="store_profile_unit"> 
                {{name}} <span>UNIT {{unit}} ({{name_2}} FT<sup>2</sup>)</span>
            </h2>
        </div>
                
        <h3 class="store_title" id="store_title">{{name}}</h3>
        <h3 class="store_title" id="neighbour_store_title">Design Requirements - {{neighbourhood}} <a class='expend_all' href='javascript:expend_all();'>expand all</a></h3>
        <h3 class="store_title" id="no_neighbour_store_title">Design Requirements </h3>
        
        <div class="store_list_padding store_detail_info">
            <h4>contact information</h4>
            <p>
                <strong style="{{show}}">Website: </strong> <a href="{{website}}">{{website}}</a> <br/>
                <strong style="{{phone_show}}">Phone: </strong> {{phone}}<br/>
                <strong>Address: </strong> <br/>
                
                Unit {{unit}}<br/>
                
                {{property.address1}}<br/>
                {{property.city}}, {{property.province_state}}<br/>
                {{property.postal_code}}<br/>
            </p>
            
            <p>
                {{description}}
            </p>
            
            <h4 style="{{tags_show}}">brands</h4>
            <p style="{{tags_show}}">
               -{{tags}}-
            </p>
            
            
            <h4 style="{{payment_show}}">accepted methods of payment</h4>
            
            <ul style="{{payment_show}}" class="payment">
            
                <li>- {{payment}}</li>
           
            </ul>
            
            
            <h4 style="{{return_show}}">return/exchange policy</h4>
            <p>{{return_policy}}</p>
           
            <h3 id="promotions_header">Sales & Promotions</h3>
            <div id="promos_container">
            </div>
            
            <h3 id="jobs_header">Job Postings</h3>
            <div id="jobs_container"></div>
                
            <p class="back store_list_padding">
                <a href="/stores"><img src="//codecloud.cdn.speedyrails.net/sites/592482696e6f6450ebc40000/image/png/1496256809000/back.png">Back to Directory</a>
            </p>
        </div>
        <div class="store_list_padding unit_info">
            <span id="hold_desc">{{description_2}}</span>
            <p class="download_design_spec">
                    <a style="{{repo_show}}" href="{{repo}}" target="_blank">You can click here to download these design specs as an Adobe PDF file.</a>                        
               
                    <i style="{{no_repo_show}}">Sorry, no design requirements are available for this unit.</i>
             
            </p>
            <p class="back">
                <a href="/stores?building=1&menu=0"><img src="//codecloud.cdn.speedyrails.net/sites/592482696e6f6450ebc40000/image/png/1496256809000/back.png">List tenants...</a>
            </p>
        </div>
    </div>
    </script>
</div>
<!-- Promotions Template -->
<script id="promos_template" type="x-tmpl-mustache/text">
    <ul class="stoore_links store_list_padding">
        <li>- <a href="/promotions/{{slug}}">{{name}}</a></li>
    </ul>
</script>
<!-- End Promotions Template -->

<!-- Jobs Template-->
<script id="jobs_template" type="x-tmpl-mustache/text">
    <ul>
        <li>-
            <a href="/jobs/{{slug}}" class="read_more">View Requirements</a>
         </li>
    </ul>
</script>

<!-- End Jobs Template-->
<script type="text/javascript" src="//codecloud.cdn.speedyrails.net/sites/592482696e6f6450ebc40000/text/javascript/1495734604000/jquery.js"></script>
<script type="text/javascript" src="//codecloud.cdn.speedyrails.net/sites/592482696e6f6450ebc40000/text/javascript/1495734613000/raphael.js"></script>
<script type="text/javascript" src="//codecloud.cdn.speedyrails.net/sites/592482696e6f6450ebc40000/text/javascript/1495734619000/jquery.mousewheel.js"></script>
<script type="text/javascript" src="//codecloud.cdn.speedyrails.net/sites/592482696e6f6450ebc40000/text/javascript/1495734624000/mapsvg.js"></script>



<script>
    $(document).ready(function(e){
        init(e); 
        $(".flexslider").remove();
        loadMallData(renderAll); 
    });
    var map_hide = true;
    function renderAll(){
        var pathArray = window.location.pathname.split( '/' );
        var slug = pathArray[pathArray.length-1];
        var store =getStoreDetailsBySlug(slug);
        renderStoreDetails("#store_detail", "#store_detail_template",store,slug);
        
        var store_promo_ids = store.promotions
        var store_promos = getPromotionsForIds(store_promo_ids).sortBy(function(o){ return o.start_date });
        var published_promos = [];
        $.each( store_promos , function( key, val ){
            // today = new Date();
            // webDate = new Date(val.show_on_web_date)
            
            today = moment();
            webDate = moment(val.show_on_web_date);
            if (today >= webDate) {
                published_promos.push(val)
            } 
        });
        if (published_promos.length > 0){
            renderPromotions("#promos_container","#promos_template", published_promos);
        }
        else {
            $('#promotions_header').hide();
        }
        
        var store_job_ids = store.jobs
        var store_jobs = getJobsForIds(store_job_ids).sortBy(function(o){ return o.start_date });
        var published_jobs = [];
        $.each( store_jobs , function( key, val ){
            // today = new Date();
            // webDate = new Date(val.show_on_web_date)
            
            today = moment();
            webDate = moment(val.show_on_web_date);
            if (today >= webDate) {
                published_jobs.push(val)
            } 
        });
        if (published_jobs.length > 0){
            renderJobs('#jobs_container', '#jobs_template', published_jobs);
        }
        else {
            $('#jobs_header').hide();
        }
        var svgH;
        var svgW;
        if ($(window).width() <= 479){
            svgH = 186;
            svgW = 295;
        } else if ($(window).width() <= 767){
            svgH = 300;
            svgW = 366;
        } else{
            svgH = 375;
            svgW = 970;
        }
        console.log(svgH,svgW);
        reg = {}
        if(store.svgmap_region != null && typeof(store.svgmap_region)  != 'undefined'){
            obj = {};
            obj["tooltip"] = "<label class='store_name_map'> "+store.name +"</label>"
            obj["attr"] = {}
            obj["attr"]["href"] = '/stores/'+store.slug 
            reg[store.svgmap_region] = obj
        }
       
        $('#mapsvg').mapSvg({
            source: '//codecloud.cdn.speedyrails.net/sites/592482696e6f6450ebc40000/image/svg+xml/1495736476000/StVital_Map_2016-09-30.svg',    // Path to SVG map
            colors: {stroke: '#aaaaaa', selected: "#F3047A", hover: 0},
            width: svgW,
            height:svgH,
            popover: 'auto',
            disableAll: true,
            viewBox: [520,150,1350,1400],
            regions: reg,
            tooltipsMode:   'custom',
            zoom: false,
            pan:false,
            cursor:'pointer',
            responsive:true,
            zoomLimit: [-1,5]
        });


        $(".unit_info ul li").each(function(){
            $(this).prepend("- ")
        })
        
        
        if (getURLParameter("building") == "1"){
            $(".unit_info").show();            
            //console.log("building");
            $("#store_profile_unit").show();
            $("#store_profile").hide();
            $("#neighbour_store_title").hide();
            $("#no_neighbour_store_title").hide();
            //$(".map_area h2.store_profile").html("{{name}} <span>UNIT {{unit}} ({{name_2}} FT<sup>2</sup>)</span>");
            if (store.neighbourhood ) {
                //$(".map_area h3.store_title").html("Design Requirements - {{neighbourhood}} <a class='expend_all' href='javascript:expend_all();'>expand all</a>");
                $("#neighbour_store_title").show();
                $("#no_neighbour_store_title").hide();
                $("#store_title").hide();
            }
            else {
                $("#neighbour_store_title").hide();
                $("#store_title").hide();
                $("#no_neighbour_store_title").show();
                //$(".map_area h3.store_title").html("Design Requirements")
            }
            
            $(".unit_info span").each(function(){
                var desc = $(this).text();
                $(this).html("");
                //console.log(desc);
                //parse description_2
                var separate_des2 = desc.match(/[^\r\n]+/g);
                //var design_desc = [];
                //var design_title = [];
                var paragraph="";
                var title;
                $.each( separate_des2 , function( des2_key, des2_val ) {
                    if(des2_val != " ")
                    {
                        if((/^\s+\d/).test(des2_val ))//((des2_val).startsWith(" 1") )
                        {
                            //console.log("h2",des2_val);
                            if(paragraph.length > 0){
                                var temp = "<span>" + paragraph + "</span><br/>";
                                //design_desc.push(temp);
                                $(temp).appendTo(".unit_info#hold_desc"); 
                                paragraph = "";
                            }
                            title="<h2><strong>"+des2_val+"</strong> <span>read more</span></h2><br/>";
                            $(title).appendTo(".unit_info#hold_desc"); 
                            //console.log($(".unit_info span").html());
                            //design_title.push(title);
                            //design_desc.push(title);
                        }
                        else {
                            //console.log("text",des2_val);
                            paragraph += des2_val;
                        }
                        //console.log(des2_key ,des2_val);
                    }
                });
                //$(this).html("<strong>"+title+"</strong> <span>read more</span>");                                
                //$("<p class='readless'>read less</p>").insertBefore( $(this) );
            })
            $(".readless").first().remove();
            $(".unit_info h2").click(function(){
                $(this).nextUntil( "h2" ).show();
            })
            
            $(".readless").on("click",function(){
                $(this).hide();
                $(this).prevUntil( "h2" ).hide();
            })
            
            $(".unit_info ul, .unit_info p").hide(); 
            $(".unit_info ul li ul").show();
            $(".download_design_spec, .back").show();            
        } else{
            $(".store_detail_info").show();
            $("#store_profile_unit").hide();
            $("#store_profile").show();
        }
        show_content();
    }
    function toggle_map(){                
        $(".store_img img").toggle();
        if (map_hide){            
            $(".store_img a").addClass("mapview");            
            map_hide = false;
        } else{
            $("#mapshot-toggle").removeClass("mapview");            
            map_hide = true;
        }
    }
    function expend_all(){
             $(".unit_info ul, .unit_info p").show();
         }
</script>